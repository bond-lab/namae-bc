{% extends 'layout.html' %}

{% block head %}
<!-- D3 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<!-- Shared utils -->
<script src="{{ url_for('static', filename='js/d3_utils.js') }}"></script>
<!-- Generic plotter + irregular wrapper -->
<script src="{{ url_for('static', filename='js/plot_irregular.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-3">{{ title }}</h1>
  <p class="text-muted">All available genderedness datasets are shown below. Click ‚ÄúShow table‚Äù to view raw rows.</p>

  {% for ds in datasets %}
  <div class="card mb-4">
    <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
      <div class="me-2">
        <h5 class="mb-1">{{ ds.caption }}</h5>
        <small class="text-muted">Dataset key: <code>{{ ds.key }}</code></small>
      </div>
      <div class="d-flex gap-2">
        <button id="btn-save-{{ loop.index0 }}" class="btn btn-sm btn-outline-primary" title="Download plot as PNG">
          üíæ Save Plot
        </button>
        <button class="btn btn-sm btn-outline-secondary" type="button"
                data-bs-toggle="collapse" data-bs-target="#tbl-{{ loop.index0 }}"
                aria-expanded="false" aria-controls="tbl-{{ loop.index0 }}">
          üìã Show table
        </button>
      </div>
    </div>

    <div class="card-body">
      <!-- Summary -->
      <div class="row">
        <div class="col-md-8">
          <div id="plot-{{ loop.index0 }}" style="min-height: 520px;"></div>
        </div>
        <div class="col-md-4">
          <div class="alert alert-info small">
            <div class="fw-bold mb-1">Trend summary</div>
            <ul class="mb-0 ps-3">
              <li>{{ ds.summary.M }}</li>
              <li>{{ ds.summary.F }}</li>
            </ul>
            <div class="mt-2 text-muted">
              Significance threshold p &lt; 0.05.
            </div>
          </div>
        </div>
      </div>

      <!-- Collapsible table (hidden by default) -->
      <div id="tbl-{{ loop.index0 }}" class="collapse mt-3">
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>Year</th>
                <th>Gender</th>
                <th class="text-end">Genderedness</th>
              </tr>
            </thead>
            <tbody>
              {% for row in ds.data %}
              <tr>
                <td>{{ row.year }}</td>
                <td>{{ row.gender }}</td>
                <td class="text-end">{{ "%.3f"|format(row.value) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
  {% endfor %}
</div>

<script>
  // From Flask
  const datasets = {{ datasets | tojson }};
  const maleColorName = {{ male_color | tojson }};
  const femaleColorName = {{ female_color | tojson }};
  const maleColor = getColorHex(maleColorName);
  const femaleColor = getColorHex(femaleColorName);

  // Render all datasets on load
  document.addEventListener('DOMContentLoaded', () => {
    datasets.forEach((ds, i) => {
      const containerId = `plot-${i}`;
      plotDataAndTrend(ds.data, containerId, {
        width: document.getElementById(containerId).offsetWidth || 800,
        height: 500,
        maleColor,
        femaleColor,
        regressionStats: ds.regression_stats,
        yLabel: 'Genderedness'
      });
      setupDownloadButton(`btn-save-${i}`, containerId, `${ds.key}.png`);
    });
  });

  // Re-render on resize (throttled)
  let rz;
  window.addEventListener('resize', () => {
    clearTimeout(rz);
    rz = setTimeout(() => {
      datasets.forEach((ds, i) => {
        const containerId = `plot-${i}`;
        plotDataAndTrend(ds.data, containerId, {
          width: document.getElementById(containerId).offsetWidth || 800,
          height: 500,
          maleColor,
          femaleColor,
          regressionStats: ds.regression_stats,
          yLabel: 'Genderedness'
        });
      });
    }, 250);
  });
</script>
{% endblock %}
