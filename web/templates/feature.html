{% extends 'layout.html' %}
{% from 'macros.html' import add_pron %}

{% block css %}
<link href="{{ url_for('static', filename='css/home.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}

<!-- Color and sort according to type   -->
{% set m = data|length %}
{% set is_length_feature = feats[0] in ["script", "olength", "mlength", "slength"] %}

<div class="container">
  <h1>{{title}}</h1>
  <div>
    <p>There are {{"{:,d}".format(m)}} different features with more than
      {{threshold}} example(s) from the {{db_name}} database.
      These come from {{"{:,d}".format(summ['allm'])}} male names
      and {{"{:,d}".format(summ['allf'])}}
      female names ({{"{:,d}".format(summ['allt'])}} together).

      <p>χ² = {{"{:.3f}".format( summ['chi2'])}}
	with pvalue {{"{:.2e}".format(summ['pval'])}}.</p>
      <p>φ = {{"{:.3f}".format(summ['phi'])}}</p>

      <p>Adjusted significance threshold α′ =
      {{"{:.2e}".format(summ['lvl'])}} for individual significance
      tests with Bonferroni's correction.
	  
  </div>
  
  <div style="display: flex; align-items: center; gap: 1em;">
    <div id="dt-filter-container"></div> <!-- Container for custom filters -->
  </div>
  <div>
  <table id='data' class="table table-hover table-borderless w-auto">
    <caption>Names, Gender and more</caption>
    <thead class="thead-light">
    <tr>
      <th>Feature</th> <th>Male</th> <th>Female</th> <th>Total</th> <th>F Ratio</th>
      <th>Odds ratio</th> <th>Pvalue</th> <th>Sig.</th> <th>Examples</th>
    </tr>
    </thead>
    <tbody>
      {%- for (feat, male, female, fratio, odds, pvalue, sig, exe) in tests %}
  <tr style="background: linear-gradient(to right, lightblue, {{ (1-fratio)*100 }}%, pink);">
    <td> {{ feat }} </td>
	<td align='right'>{{male}}</td>
	<td align='right'>{{female}}</td>
	<td align='right'>{{female+male}}</td>
	<td align='right'>{{"{:.4f}".format(fratio)}}</td>	
	<td align='right'>{{"{:.4f}".format(odds)}}</td>
	<td align='right'>{{"{:.2e}".format(pvalue)}}</td>
	<td align='right'>{{sig}}</td>
	<td>{%- for (o, p) in exe %}
	  <a href='{{url_for('namae', orth=o, pron=p)}}'>{{o}}</a>{{", " if not loop.last else ""}}
	{% endfor %} 
	</td>
      </tr>
      {% endfor %}
        </tbody>
    </table>

  <hr>

{% macro render_book_table(title_suffix, filter_type, sort_attr=None, sort_reverse=False) %}
<h2>Table for {{ title }}{% if title_suffix %} ({{ title_suffix }}){% endif %}</h2>

<table id="book-table" style="border-collapse:collapse;">
  <thead>
    <tr>
      <th>{{ title }}</th>
      <th>Boys</th>
      <th>Girls</th>
      <th>F Ratio</th>
      <th>p-adj</th>
    </tr>
  </thead>
  <tbody>
    {% set sorted_tests = tests|sort(attribute=sort_attr, reverse=sort_reverse) if sort_attr is not none else tests %}
    {% for (feat, male, female, fratio, odds, pvalue, sig, exe) in sorted_tests %}
      {% set p_adj = m * pvalue %}
      {% set show_row = (filter_type == "all") or (filter_type == "girls" and fratio > (1 - beta)) or (filter_type == "boys" and fratio < beta) %}
      {% if show_row %}
        {% set signif = p_adj < 0.05 %}
        <tr class="{% if not signif and not is_length_feature %}nonsig{% endif %}">
          <td>{{ add_pron(feat, feats[0]) }}</td>
          <td style="text-align:right;">{{ "{:,d}".format(male) }}</td>
          <td style="text-align:right;">{{ "{:,d}".format(female) }}</td>
          <td style="text-align:right;">{{ "%.2f"|format(fratio) }}</td>
          <td style="text-align:right;">
            {% if signif %}<strong>{% endif %}
            {% if p_adj < 0.001 %}
              &lt;0.001
            {% else %}
              {{ "%.3f"|format(p_adj) }}
            {% endif %}
            {% if signif %}</strong>{% endif %}
          </td>
        </tr>
      {% endif %}
    {% endfor %}
  </tbody>
</table>
<p id="sig-note" class="caption-note">
  Significance uses Bonferroni correction (m = {{ m }}, familywise α = 0.05).
  {% if not is_length_feature %}
  <span id="note-hide">Only significant features shown.</span>
  <span id="note-show" style="display:none;">
    Rows in <strong>bold</strong> pass the corrected threshold.
  </span>
  {% endif %}
</p>
{% endmacro %}

{% if is_length_feature %}
  {{ render_book_table("", "all") }}
{% else %}
  {{ render_book_table("Girls: F-ratio > " ~ (1-beta), "girls", 3, True) }}
  {{ render_book_table("Boys: F-ratio < " ~ beta, "boys", 3, False) }}
{% endif %}

{% if not is_length_feature %}
<p><label>
  <input type="checkbox" id="show-nonsig"
         data-default='false'>
  Show non-significant rows
</label></p>
{% endif %}

  </div>
  </div>
{% endblock %}


{% block scripts %}
  <script>
    $(document).ready(function () {
	$('#data').DataTable({"pageLength": 100,
			      "lengthMenu": [ [25, 50, 100, -1],
					      [25, 50, 100, "All"] ],
          
	initComplete: function () {
            var api = this.api();

               // Create a label for Filters
                var filterLabel = $('<span><strong>Filters:</strong></span>');

                // Create dropdowns for Min and Max F Ratio with values from 0 to 1.0 in steps of 0.1
                var minDropdown = $('<select id="min-f-ratio"><option value="">Min</option></select>')
                    .on('change', function () {
                        table.draw();
                    });
                
                var maxDropdown = $('<select id="max-f-ratio"><option value="">Max</option></select>')
                    .on('change', function () {
                        table.draw();
                    });

                // Populate dropdowns with values from 0 to 1.0 in steps of 0.1
                for (var i = 0; i <= 1.0; i += 0.1) {
                    var value = i.toFixed(1); // Convert to string with 1 decimal place
                    minDropdown.append('<option value="' + value + '">' + value + '</option>');
                    maxDropdown.append('<option value="' + value + '">' + value + '</option>');
                }

                // Create dropdown for Sig. filter with options for All, true, and false
                var sigDropdown = $('<select id="sig-filter"><option value="">All</option><option value="true">True</option><option value="false">False</option></select>')
                    .on('change', function () {
                        var val = $.fn.dataTable.util.escapeRegex($(this).val());
                        api.column(7).search(val ? '^' + val + '$' : '', true, false).draw();
                    });

                // Create a label for F-ratio and Significance
                var fRatioLabel = $('<span>F-ratio</span>');
                var sigLabel = $('<span>Significance</span>');

                // Append everything in a descriptive format
                $('#dt-filter-container').append(filterLabel, fRatioLabel, minDropdown, maxDropdown, sigLabel, sigDropdown);

                // Custom filter function for Min and Max F Ratio
                $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                    var min = parseFloat(minDropdown.val()) || -Infinity; // Default to -Infinity if not set
                    var max = parseFloat(maxDropdown.val()) || Infinity;  // Default to Infinity if not set
                    var fRatio = parseFloat(data[4]) || 0; // Column 4 holds the F Ratio value

                    return (fRatio >= min && fRatio <= max);
                });
	}
    });

    });

    {% if not is_length_feature %}
    /* toggle for the book table */
   document.addEventListener("DOMContentLoaded", function () {
    const checkbox = document.getElementById("show-nonsig");
    const rows = document.querySelectorAll("#book-table tbody tr.nonsig");
    const noteHide = document.getElementById("note-hide");
    const noteShow = document.getElementById("note-show");

    // apply initial state from Jinja
    const defaultState = checkbox.dataset.default === "true";
    checkbox.checked = defaultState;

    function updateState() {
      const show = checkbox.checked;
      // toggle row visibility
      rows.forEach(r => r.style.display = show ? "" : "none");
      // toggle which text span is visible
      noteHide.style.display = show ? "none" : "";
      noteShow.style.display = show ? "" : "none";
    }

    checkbox.addEventListener("change", updateState);
    updateState(); // initialize on load
  });
  {% endif %}
    </script>
  <style>
    /* CSS to align elements inline and provide spacing */
    #dt-filter-container {
        display: flex;
        align-items: center;
        gap: 0.5em; /* Space between filter elements */
    }

    #dt-filter-container select {
        width: auto; /* Adjust width for dropdowns to be compact */
    } 
</style>
 <style>
  .caption-note {
    font-size: 90%;
    font-style: italic;
    color: #444;
    margin-top: 0.5em;
    margin-bottom: 1.5em;
    max-width: 70em;
  }
</style>   
</div>
{% endblock %}
